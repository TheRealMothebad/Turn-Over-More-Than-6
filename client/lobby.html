<!DOCTYPE html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<title>Turn Over More Than 6</title>
<link rel="stylesheet" type="text/css" href="style.css" />
</head>

<body>
  <h2 id="welcomeMessage"></h2>

  <h3>Players in lobby:</h3>
  <div id="player-list">
    <p>Player list will be available soon.</p>
  </div>

  <button type="button" onclick="start_game()">Start Game</button>
  <p id="errors"></p>

  <script src="dev.js"></script>
  <script>
    let pollingInterval;
    let baseUrl = "https://tomt6.umbriac.com";

    (async () => {
      if (window.IS_DEV) {
        console.log('Development environment detected, using localhost.');
        baseUrl = 'http://localhost:8080';
      }
    })();

    document.addEventListener("DOMContentLoaded", () => {
      let name = localStorage.getItem("name") || sessionStorage.getItem("name");
      if (!name) {
        const urlParams = new URLSearchParams(window.location.search);
        name = urlParams.get("name");
      }

      if (name) {
        document.getElementById("welcomeMessage").textContent = `Welcome ${name}, waiting for game to start...`;
      } else {
        document.getElementById("welcomeMessage").textContent = "Welcome (name error?), waiting for game to start...";
      }
      pollingInterval = setInterval(check_game_status, 2000); // Check every 2 seconds
    });

    async function check_game_status() {
      let uuid = localStorage.getItem("uuid") || sessionStorage.getItem("uuid");
      if (!uuid) {
        const urlParams = new URLSearchParams(window.location.search);
        uuid = urlParams.get("uuid");
      }

      try {
        const response = await fetch(`${baseUrl}/game_status?uuid=${uuid}`);
        if (response.ok) {
          const data = await response.json();
          if (data.game_started) {
            clearInterval(pollingInterval);
            window.location.href = `game.html?uuid=${uuid}`;
          }
        }
      } catch (error) {
        console.error("Error checking game status:", error);
      }
    }

    function start_game() {
      const uuid = localStorage.getItem("uuid");

      if (!uuid) {
        document.getElementById("errors").innerHTML = "Could not identify you.";
        return;
      }

      fetch(`${baseUrl}/start`, {
        method: "POST",
        body: JSON.stringify({
          uuid: uuid
        }),
        headers: {
          "Content-type": "application/json; charset=UTF-8"
        }
      }).then(response => {
        if (!response.ok) {
          response.text().then(text => {
            document.getElementById("errors").innerHTML = text;
          });
          return Promise.reject('server error');
        }
        console.log("Start game request successful.");
      })
      .catch(error => {
        console.error("Error starting game:", error);
      });
    }
  </script>
</body>